---
import { cn } from '~/lib/utils'
import type { SkillsCardConfig, SkillsShowcaseItem, SkillsShowcaseRow } from '~/config'

interface Props {
  config: SkillsCardConfig
}

const { config } = Astro.props

const duplicateItems = (items: SkillsShowcaseItem[]) => [...items, ...items, ...items, ...items]
---

<div class="py-8 pb-10 px-6 max-md:px-6">
  <div class="px-2 max-md:px-0">
    <h2 class="text-2xl sm:text-3xl tracking-tight">{config.title}</h2>
    <p class="text-muted-foreground mb-6 mt-1">{config.description}</p>
  </div>
  <div class="relative py-2 px-2 max-md:px-0">
    {
      config.data.map((row: SkillsShowcaseRow) => {
        const duplicatedItems = duplicateItems(row.items)
        return (
          <div class="relative w-full overflow-hidden my-4 group">
            <div
              class={cn(
                'flex w-max will-change-transform',
                row.direction === 'right' ? 'animate-[scroll-reverse_30s_linear_infinite]' : 'animate-[scroll_30s_linear_infinite]',
                'group-hover:[animation-play-state:paused]',
                'safari-only'
              )}
              style="transform: translateZ(0); -webkit-transform: translateZ(0);"
            >
              {duplicatedItems.map((item) => {
                const props = { href: item.url, target: '_blank', rel: 'noopener noreferrer' }
                return (
                  <a
                    class="safari-item group flex items-center gap-2 px-5 py-2 mx-2 rounded-full border border-border bg-accent text-foreground whitespace-nowrap hover:bg-tag-bg-hover dark:shadow-md transition-colors"
                    {...props}
                  >
                    <span class={cn('flex items-center justify-center w-5 h-5', item.icon)} />
                    <span class="font-sans text-sm font-medium">{item.name}</span>
                  </a>
                )
              })}
            </div>
          </div>
        )
      })
    }
  </div>
</div>

<style is:global>
  @-webkit-keyframes scroll {
    0% {
      -webkit-transform: translate3d(0, 0, 0);
      transform: translate3d(0, 0, 0);
    }
    100% {
      -webkit-transform: translate3d(-25%, 0, 0);
      transform: translate3d(-25%, 0, 0);
    }
  }

  @keyframes scroll {
    0% {
      -webkit-transform: translate3d(0, 0, 0);
      transform: translate3d(0, 0, 0);
    }
    100% {
      -webkit-transform: translate3d(-25%, 0, 0);
      transform: translate3d(-25%, 0, 0);
    }
  }

  @-webkit-keyframes scroll-reverse {
    0% {
      -webkit-transform: translate3d(-25%, 0, 0);
      transform: translate3d(-25%, 0, 0);
    }
    100% {
      -webkit-transform: translate3d(0, 0, 0);
      transform: translate3d(0, 0, 0);
    }
  }

  @keyframes scroll-reverse {
    0% {
      -webkit-transform: translate3d(-25%, 0, 0);
      transform: translate3d(-25%, 0, 0);
    }
    100% {
      -webkit-transform: translate3d(0, 0, 0);
      transform: translate3d(0, 0, 0);
    }
  }

  /* Safari 优化 */
  .safari-only {
    -webkit-transform-style: preserve-3d;
    transform-style: preserve-3d;
  }

  .safari-item {
    -webkit-transform: translate3d(0, 0, 0);
    transform: translate3d(0, 0, 0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    /* Chrome 优化 */
    contain: layout style paint;
    will-change: transform;
  }
</style>

<script>
  function adjustAnimationSpeed() {
    const tracks = document.querySelectorAll<HTMLElement>('.flex.w-max')
    const screenWidth = window.innerWidth
    const baseSpeed = 30
    const speedFactor = Math.max(0.6, Math.min(1.8, screenWidth / 1000))
    const newDuration = `${baseSpeed * speedFactor}s`

    tracks.forEach((track) => {
      track.style.animationDuration = newDuration
    })
  }

  // 监听事件
  window.addEventListener('before-swap', adjustAnimationSpeed)
</script>
