---
import { formatDate, cn, DEFAULT_TIME_ZONE } from '~/lib/utils'

interface Props {
  frontmatter: any
}

const { frontmatter } = Astro.props
const topText = 'TOP'
const articleDate = frontmatter?.createTime
const lastEditedDate = (() => {
  const value = frontmatter?.lastEditedTime
  if (!value) return null
  if (value instanceof Date) return value
  if (typeof value !== 'string') return null

  const match = value.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2})(?::(\d{2}))?$/)
  if (match) {
    const [, year, month, day, hour, minute, second] = match
    return new Date(Date.UTC(Number(year), Number(month) - 1, Number(day), Number(hour) - 8, Number(minute), Number(second ?? '0')))
  }

  const parsed = new Date(value)
  return Number.isNaN(parsed.getTime()) ? null : parsed
})()

const formatLastEditedTime = (date: Date) => {
  const timeText = date.toLocaleTimeString('en-US', {
    timeZone: DEFAULT_TIME_ZONE,
    hour: '2-digit',
    minute: '2-digit',
    hour12: false,
  })
  const dateText = date.toLocaleDateString('en-US', {
    timeZone: DEFAULT_TIME_ZONE,
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  })
  return `${timeText}, ${dateText}`
}

const badgeSizeClass = 'text-xs px-2 py-0.5 gap-1'
const tagBadgeClass = 'bg-muted/40 text-muted-foreground hover:bg-muted/60 hover:text-foreground border border-transparent'
const recommendBadgeClass =
  'border border-transparent bg-gradient-to-r from-slate-500/15 via-blue-500/15 to-indigo-500/15 text-slate-700 dark:text-slate-300 hover:from-slate-500/25 hover:via-blue-500/25 hover:to-indigo-500/25'
const tagIconClass = 'icon-[heroicons--hashtag-16-solid]'
const recommendIconClass = 'icon-[garden--sparkle-fill-16]'
const unfinishedText = 'Unfinished'
---

<header>
  <div class="space-y-4 md:space-y-5">
    {frontmatter.description && <p class="text-sm text-muted-foreground/90 leading-relaxed">{frontmatter.description}</p>}

    <div class="text-xl lg:text-2xl font-semibold leading-tight" data-pagefind-body>
      {frontmatter.title}
    </div>

    {
      (articleDate || frontmatter.words !== undefined) && (
        <div class="flex flex-wrap items-center gap-3 sm:gap-4 text-sm text-muted-foreground/85">
          {articleDate && (
            <div class="flex items-center gap-1.5">
              <span class="icon-[ph--calendar-blank] w-4 h-4 opacity-85" />
              <time datetime={articleDate.toISOString()}>{formatDate(articleDate)}</time>
            </div>
          )}

          {lastEditedDate && (
            <div class="flex items-center gap-1.5">
              <span class="icon-[ph--pencil-simple] w-4 h-4 opacity-85" />
              <time datetime={lastEditedDate.toISOString()}>{formatLastEditedTime(lastEditedDate)}</time>
            </div>
          )}

          {frontmatter.words !== undefined && (
            <div class="flex items-center gap-1.5">
              <span class="icon-[ph--book-open-text] w-4 h-4 opacity-85" />
              <span>{frontmatter.words} words</span>
            </div>
          )}
        </div>
      )
    }

    {
      (frontmatter.top || frontmatter.tags?.length || frontmatter.completed === false) && (
        <div class="flex gap-2 sm:gap-2.5 lg:gap-3 flex-wrap">
          {frontmatter.top && (
            <span
              class={cn(
                'inline-flex items-center font-medium transition-colors duration-200 select-none',
                badgeSizeClass,
                recommendBadgeClass
              )}
              title="Top"
            >
              <span class={recommendIconClass} />
              <span class="font-semibold tracking-wide">{topText}</span>
            </span>
          )}
          {frontmatter.completed === false && (
            <span
              class={cn('inline-flex items-center font-medium transition-colors duration-200 select-none', badgeSizeClass, tagBadgeClass)}
              title={unfinishedText}
            >
              {unfinishedText}
            </span>
          )}
          {frontmatter.tags?.map((tag: string) => (
            <a
              href={`/tags/${tag}`}
              aria-label={`View posts tagged with ${tag}`}
              class={cn('inline-flex items-center font-medium transition-colors duration-200 select-none', badgeSizeClass, tagBadgeClass)}
            >
              <span class={tagIconClass} />
              {tag}
            </a>
          ))}
        </div>
      )
    }
  </div>
  <div class="border-b border-border/60 my-8 sm:my-10 lg:my-12"></div>
</header>
