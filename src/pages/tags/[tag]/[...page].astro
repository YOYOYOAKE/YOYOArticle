---
import type { GetStaticPaths, Page } from 'astro'
import type { CollectionEntry } from 'astro:content'
import { listsConfig } from '~/config'
import TagedPostsList from '~/layouts/components/Main/Lists/TagedPostsList.astro'
import { getAllPosts, getAllTags } from '~/lib/data'

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const [allPosts, tagsMap] = await Promise.all([getAllPosts(), getAllTags()])

  const uniqueTags = Object.keys(tagsMap)

  return uniqueTags
    .map((tag) => {
      const tagPosts = allPosts.filter((post) => post.data.tags?.includes(tag))
      return paginate(tagPosts, {
        params: { tag },
        props: { tag },
        pageSize: listsConfig.taggedPostsList.pagination.eachPageSize,
      })
    })
    .flat()
}

interface Props {
  page: Page<CollectionEntry<'posts'>>
  tag: string
}

const { page, tag } = Astro.props
---

<TagedPostsList {page} {tag} />
