---
title: 'Clash(Mihomo) çš„ Linux éƒ¨ç½²æŒ‡å—'
description: 'æœ¬æ–¹æ¡ˆé€šè¿‡ Docker éƒ¨ç½² Clash(Mihomo)ï¼Œå¹¶ä½¿ç”¨ Cloudflare Tunnel å®ç°å®‰å…¨ç®¡ç†ã€‚'
category: 'posts'
createTime: 2026-02-15
lastEditedTime: 2026-02-15 15:32:00
completed: true
top: false
tags: ['Ubuntu/Debian', 'Docker']
---

## 1 Clash(Mihomo) å†…æ ¸é…ç½®ä¸è®¢é˜…ç®¡ç†


### 1.1 ç¯å¢ƒä¸å®¹å™¨


å»ºè®®ç»Ÿä¸€ç®¡ç† Clash çš„é…ç½®æ–‡ä»¶ä¸å®¹å™¨é…ç½®ã€‚æ¨èç›®å½•ç»“æ„å¦‚ä¸‹ï¼š


```
~/apps/clash/
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ config/
    â””â”€â”€ config.yaml
```


åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºå¹¶ç¼–è¾‘ `docker-compose.yml` æ–‡ä»¶ï¼š


```yaml
services:
  clash:
    image: metacubex/mihomo:latest
    container_name: clash
    restart: always
    volumes:
      - ./config:/root/.config/mihomo
    network_mode: host
```


> [!tip] æ³¨æ„äº‹é¡¹
> - **ç½‘ç»œæ¨¡å¼**ï¼šä½¿ç”¨äº† `network_mode: host` æ¨¡å¼ï¼Œå®¹å™¨å°†ç›´æ¥å…±äº«å®¿ä¸»æœºçš„ç½‘ç»œæ ˆï¼ŒClash é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„ç«¯å£ï¼ˆå¦‚ `7890` å’Œ `9090`ï¼‰ä¼šç›´æ¥åœ¨å®¿ä¸»æœºä¸Šç›‘å¬ã€‚
> - **é¢æ¿è¯´æ˜**ï¼šMihomo é•œåƒä»…åŒ…å«æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸å«å›¾å½¢ç•Œé¢ã€‚éœ€é…åˆ Web UI ä½¿ç”¨ï¼Œæ¨èä½¿ç”¨åœ¨çº¿é¢æ¿ï¼š[Metacubexd](https://metacubex.github.io/metacubexd/)ã€‚


### 1.2 é…ç½®æ–‡ä»¶è¯¦è§£


é€šå¸¸ï¼Œæœºåœºæä¾›çš„è®¢é˜…é“¾æ¥ç›´æ¥åŒ…å«äº†ä¸€ä¸ªå®Œæ•´çš„ `config.yaml`ã€‚ç›´æ¥è¦†ç›–ä½¿ç”¨è™½ç„¶ç®€å•ï¼Œä½†ä¼šå¯¼è‡´è‡ªå®šä¹‰é…ç½®ï¼ˆå¦‚ DNSã€è‡ªå®šä¹‰è§„åˆ™ï¼‰ä¸¢å¤±ã€‚


æ›´ä¼˜é›…çš„åšæ³•æ˜¯ï¼š**ç¼–å†™ä¸€ä¸ªæœ¬åœ°çš„ä¸»é…ç½®æ–‡ä»¶ï¼Œé€šè¿‡** **`proxy-providers`** **å¼•ç”¨æœºåœºè®¢é˜…ã€‚**


ä»¥ä¸‹æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„ `config.yaml` æ¨¡æ¿ã€‚


1.2.1 åŸºç¡€è®¾ç½®ä¸ DNS


æ­¤é…ç½®å¼€å¯äº†æ··åˆç«¯å£ã€IPv6 æ”¯æŒã€å±€åŸŸç½‘å…±äº«åŠå¢å¼ºå‹ DNSï¼ˆFake-IP æ¨¡å¼ï¼‰ï¼Œèƒ½æ»¡è¶³å¤§éƒ¨åˆ†éœ€æ±‚ã€‚


```yaml
# åŸºç¡€é…ç½®
mixed-port: 7890
allow-lan: true
mode: rule
log-level: info
ipv6: true
external-controller: 0.0.0.0:9090
secret: "ä½ çš„APIå¯†é’¥" # è¯·ä¿®æ”¹æ­¤å¤„çš„å¯†é’¥ï¼Œè¿æ¥ Web UI æ—¶éœ€è¦
unified-delay: true
tcp-concurrent: true

# æµé‡å—…æ¢ (Sniffer)
sniffer:
  enable: true
  sniff:
    HTTP: { ports: [80, 8080-8880], override-destination: true }
    TLS: { ports: [443, 8443], override-destination: true }
    QUIC: { ports: [443, 8443], override-destination: true }

# DNS é…ç½®
dns:
  enable: true
  listen: 0.0.0.0:1053
  ipv6: true
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16
  nameserver:
      - 223.5.5.5
      - 119.29.29.29
      - 8.8.8.8
  fallback:
    - https://1.1.1.1/dns-query
    - https://8.8.8.8/dns-query
```


1.2.2 ä»£ç†é›†åˆï¼ˆProxy Providersï¼‰


é€šè¿‡é“¾æ¥å¼•ç”¨è®¢é˜…ï¼ŒClash ä¼šæŒ‰ç…§æŒ‡å®šé—´éš”ï¼ˆæ­¤å¤„æ˜¯ 3600 ç§’ï¼Œå³ 1 å°æ—¶ï¼‰è‡ªåŠ¨æ›´æ–°èŠ‚ç‚¹ä¿¡æ¯ï¼Œå¹¶ä¿å­˜åˆ° `./provides/airport.yaml` ä¸­ã€‚


```yaml
proxy-providers:
  Airport:
    type: http
    url: "åœ¨æ­¤å¤„å¡«å…¥æœºåœºè®¢é˜…é“¾æ¥"
    path: ./providers/airport.yaml
    interval: 3600
    health-check:
      enable: true
      url: http://www.gstatic.com/generate_204
      interval: 300
```


1.2.3 ç­–ç•¥ç»„ï¼ˆProxy Groupsï¼‰


å®šä¹‰èŠ‚ç‚¹çš„é€‰æ‹©é€»è¾‘ã€‚


```yaml
proxy-groups:
  - name: "ğŸš€ èŠ‚ç‚¹é€‰æ‹©"
    type: select
    proxies:
      - "â™»ï¸ è‡ªåŠ¨é€‰æ‹©"
      - "DIRECT"
    use:
      - Airport

  - name: "â™»ï¸ è‡ªåŠ¨é€‰æ‹©"
    type: url-test
    url: http://www.gstatic.com/generate_204
    interval: 300
    tolerance: 50
    use:
      - Airport

  - name: "ğŸŒ å…¨çƒç›´è¿"
    type: select
    proxies:
      - DIRECT

  - name: "ğŸŸ æ¼ç½‘ä¹‹é±¼"
    type: select
    proxies:
      - "ğŸš€ èŠ‚ç‚¹é€‰æ‹©"
      - "DIRECT"
```


1.2.4 è§„åˆ™é›†åˆï¼ˆRule Providersï¼‰


å¼•ç”¨ Loyalsoldier ç»´æŠ¤çš„è§„åˆ™é›†ï¼Œä¿æŒè§„åˆ™çš„å®æ—¶æ›´æ–°ã€‚


```yaml
rule-providers:
  reject:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/reject.txt"
    path: ./rules/reject.yaml
    interval: 86400

  proxy:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/proxy.txt"
    path: ./rules/proxy.yaml
    interval: 86400

  direct:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/direct.txt"
    path: ./rules/direct.yaml
    interval: 86400
```


1.2.5 åˆ†æµè§„åˆ™ (Rules)


å°†æµé‡åŒ¹é…åˆ°å¯¹åº”çš„ç­–ç•¥ç»„ã€‚


```yaml
rules:
  - RULE-SET,reject,REJECT
  - RULE-SET,proxy,ğŸš€ èŠ‚ç‚¹é€‰æ‹©
  - RULE-SET,direct,DIRECT
  - GEOIP,LAN,DIRECT
  - GEOIP,CN,DIRECT
  - MATCH,ğŸŸ æ¼ç½‘ä¹‹é±¼
```


> [!note] è§„åˆ™è§£æ
> - **åŒ¹é…é€»è¾‘**ï¼šè§„åˆ™æ˜¯ä»ä¸Šå¾€ä¸‹ä¾æ¬¡æ‰§è¡Œçš„ï¼Œä¸€æ—¦åŒ¹é…æˆåŠŸï¼Œåç»­è§„åˆ™å°†ä¸å†æ‰§è¡Œã€‚
> - **RULE-SET**ï¼šå¼•ç”¨ä¸Šæ–‡å®šä¹‰çš„è§„åˆ™é›† (`rule-providers`)ã€‚
>     - `reject`ï¼šåŒ¹é…å¹¿å‘Šæˆ–æ¶æ„åŸŸåï¼Œæ‰§è¡Œ `REJECT`ï¼ˆæ‹’ç»è¿æ¥ï¼‰ã€‚
>     - `proxy`ï¼šåŒ¹é…å›½å¤–åˆ—è¡¨ï¼ˆå¦‚ Googleã€GitHubï¼‰ï¼Œæµé‡è½¬å‘ç»™ `ğŸš€ èŠ‚ç‚¹é€‰æ‹©` ç­–ç•¥ç»„ã€‚
>     - `direct`ï¼šåŒ¹é…å›½å†…åˆ—è¡¨ï¼ˆå¦‚ Bilibiliã€Baiduï¼‰ï¼Œæ‰§è¡Œ `DIRECT`ï¼ˆç›´è¿ï¼‰ã€‚
> - **GEOIP**ï¼šåŸºäº IP åœ°ç†ä½ç½®æ•°æ®åº“è¿›è¡Œåˆ¤æ–­ã€‚
>     - `LAN` / `CN`ï¼šå±€åŸŸç½‘æˆ–ä¸­å›½å¤§é™† IPï¼Œæ‰§è¡Œç›´è¿ã€‚
> - **MATCH**ï¼šå…œåº•è§„åˆ™ï¼ˆæ¼ç½‘ä¹‹é±¼ï¼‰ã€‚å¦‚æœè¯·æ±‚æ²¡æœ‰å‘½ä¸­ä¸Šè¿°ä»»ä½•ä¸€æ¡è§„åˆ™ï¼Œå°±ä¼šè½å…¥æ­¤è§„åˆ™ï¼Œäº¤ç»™ `ğŸŸ æ¼ç½‘ä¹‹é±¼` ç­–ç•¥ç»„å¤„ç†ã€‚


### 1.3 å¯åŠ¨ä¸éªŒè¯


é…ç½®å®Œæˆåï¼Œåœ¨ `docker-compose.yml` åŒçº§ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨å®¹å™¨å¹¶æŸ¥çœ‹æ—¥å¿—ï¼š


```bash
docker compose up -d && docker compose logs -f
```


ç­‰å¾…æ—¥å¿—æ˜¾ç¤ºå¯åŠ¨æˆåŠŸåï¼Œä½¿ç”¨ `curl` å‘½ä»¤éªŒè¯ä»£ç†æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š


```bash
curl -I --proxy http://127.0.0.1:7890 https://www.google.com
```


å¦‚æœè¿”å› `HTTP/2 200` æˆ– `301` çŠ¶æ€ç ï¼Œè¯´æ˜æœåŠ¡å·²æ­£å¸¸è¿è¡Œã€‚


> [!tip] åˆæ¬¡å¯åŠ¨æ•…éšœæ’é™¤
> Clash å†…æ ¸é¦–æ¬¡å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨ä¸‹è½½ GeoIP æ•°æ®åº“æ–‡ä»¶ã€‚è‹¥æœåŠ¡å™¨ç½‘ç»œç¯å¢ƒä¸ä½³ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸‹è½½è¶…æ—¶ä»è€Œå¯åŠ¨å¤±è´¥ã€‚
>
>
> æ‰‹åŠ¨ä¸‹è½½ä»¥ä¸‹æ–‡ä»¶å¹¶ä¸Šä¼ è‡³ `config` ç›®å½•ï¼Œç„¶åé‡å¯å®¹å™¨ã€‚
>
>
> ```bash
> wget -O Country.mmdb https://fastly.jsdelivr.net/gh/Dreamacro/maxmind-geoip@release/Country.mmdb
> wget -O geosite.dat https://fastly.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geosite.dat
> wget -O geoip.dat https://fastly.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geoip.dat
> ```


## 2 Metacube(XD) é¢æ¿è¿æ¥


Mihomo é•œåƒä»…åŒ…å«æ ¸å¿ƒåŠŸèƒ½ï¼Œéœ€è¦é€šè¿‡ Web é¢æ¿è¿›è¡Œå¯è§†åŒ–ç®¡ç†ã€‚


æ‰“å¼€ [Metacubexd](https://metacubex.github.io/metacubexd/)ï¼Œå¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼š

- **åç«¯åœ°å€**ï¼š`http://<ä½ çš„æœåŠ¡å™¨å…¬ç½‘IP>:9090` ï¼ˆåŠ¡å¿…æ”¾è¡Œç«¯å£ï¼‰
- **å¯†é’¥**ï¼š`config.yaml` ä¸­ `secret` å­—æ®µå¯¹åº”çš„å¯†é’¥

ç‚¹å‡» **Add** å®Œæˆè¿æ¥ã€‚


> [!warning] æ— æ³•è¿æ¥ï¼Ÿ
> å¦‚æœç‚¹å‡»è¿æ¥åæ²¡æœ‰ä»»ä½•ååº”æˆ–æç¤ºé”™è¯¯ï¼Œé€šå¸¸ç”±ä»¥ä¸‹ä¸¤ä¸ªåŸå› å¯¼è‡´ï¼š
>
> - **äº‘æœåŠ¡å™¨å®‰å…¨ç»„æˆ–é˜²ç«å¢™æœªæ”¾è¡Œç«¯å£**
>
> æ”¾è¡Œ `9090` ç«¯å£å³å¯ã€‚
>
> - **HTTPS æ··åˆå†…å®¹æ‹¦æˆª**
>
> å¦‚æœåœ¨çº¿é¢æ¿ä½¿ç”¨ `https://` åè®®åŠ è½½ï¼ˆå¦‚ GitHub Pagesï¼‰ï¼Œè€Œåç«¯ API åœ°å€ä¸º `http://`ï¼Œæµè§ˆå™¨ä¼šå‡ºäºå®‰å…¨ç­–ç•¥é™é»˜æ‹¦æˆªè¯¥è¯·æ±‚ï¼Œä¸ä¼šåœ¨é¡µé¢ä¸Šç»™å‡ºæ˜æ˜¾æç¤ºã€‚
>
>
> è‹¥å¼€å‘è€…å·¥å…·æ§åˆ¶å°å‡ºç°å¦‚ä¸‹çº¢è‰²æŠ¥é”™ï¼Œå³å¯ç¡®è®¤æ˜¯æ··åˆå†…å®¹æ‹¦æˆªï¼š
>
>
> ```
> Mixed Content: The page at 'https://...' was loaded over HTTPS,
> but requested an insecure XMLHttpRequest endpoint 'http://...'
> ```
>
>
> æ­¤æ—¶åœ¨æµè§ˆå™¨çš„**ç½‘ç«™è®¾ç½®ä¸­**å°†**ä¸å®‰å…¨å†…å®¹ï¼ˆInsecure Contentï¼‰** ä¿®æ”¹ä¸º **å…è®¸ï¼ˆAllowï¼‰**ï¼Œåˆ·æ–°é¡µé¢åé‡è¯•å³å¯ã€‚


> [!note] ä½¿ç”¨ Cloudflare Tunnel æ›¿ä»£æ–¹æ¡ˆ
> é™¤äº†ä¿®æ”¹æµè§ˆå™¨è®¾ç½®å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡ Cloudflare Tunnel å°† `9090` ç«¯å£ä»£ç†ä¸º HTTPS æœåŠ¡ï¼Œä»æ ¹æœ¬ä¸Šè§£å†³æ··åˆå†…å®¹æ‹¦æˆªé—®é¢˜ï¼ŒåŒæ—¶é¿å…ç›´æ¥æš´éœ²æœåŠ¡å™¨ç«¯å£ï¼Œæå‡å®‰å…¨æ€§ã€‚
>
>
> å‚è€ƒ [Cloudflare Tunnel é…ç½®æŒ‡å—](https://www.yoake.cc/posts/20260123-2edc/#4-%E7%BC%96%E5%86%99%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6)ï¼Œåœ¨ `config.yml` çš„ `ingress` ä¸­æ·»åŠ å¦‚ä¸‹è§„åˆ™ï¼š
>
>
> ```yaml
> ingress:
>   - hostname: proxy.yoake.cc
>     service: http://localhost:9090
> ```
>
>
> é…ç½®å®Œæˆåï¼Œå°† [Metacubexd](https://metacubex.github.io/metacubexd/) ä¸­çš„**åç«¯åœ°å€**æ”¹ä¸º `https://proxy.yoake.cc`å³å¯æ­£å¸¸è¿æ¥ã€‚
